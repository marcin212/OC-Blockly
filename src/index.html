<html>
<head>
    <title> OC Robot - Blockly</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <script src="js/lib/blockly_compressed.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/lib/blocks_compressed.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/lib/lua_compressed.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/lib/msg/en.js" type="text/javascript" charset="utf-8"></script>

    <script src="js/lib/lz-string.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/lib/gist.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/lib/splitter.js" type="text/javascript" charset="utf-8"></script>

    <script src="js/move-blocks.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/sides-blocks.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/inv-blocks.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/stack-blocks.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/geolyzer-block.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/system-blocks.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/time-blocks.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/redstone-blocks.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/zetta-blocks.js" type="text/javascript" charset="utf-8"></script>


    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" type="text/css" href="css/splitter.css">
</head>
<body>

<div class="loader hidden">
    <img src="img/loader.gif" class="loader-gif">
</div>

<xml id="toolbox" style="display: none">

    <category id="catLogic" colour="210" name="Logic">
        <block type="controls_if"></block>
        <block type="logic_compare"></block>
        <block type="logic_operation"></block>
        <block type="logic_negate"></block>
        <block type="logic_boolean"></block>
        <block type="logic_null"></block>
        <block type="logic_ternary"></block>
    </category>
    <category id="catLoops" colour="120" name="Loops">
        <block type="controls_repeat_ext">
            <value name="TIMES">
                <shadow type="math_number">
                    <field name="NUM">10</field>
                </shadow>
            </value>
        </block>
        <block type="controls_whileUntil"></block>
        <block type="controls_for">
            <value name="FROM">
                <shadow type="math_number">
                    <field name="NUM">1</field>
                </shadow>
            </value>
            <value name="TO">
                <shadow type="math_number">
                    <field name="NUM">10</field>
                </shadow>
            </value>
            <value name="BY">
                <shadow type="math_number">
                    <field name="NUM">1</field>
                </shadow>
            </value>
        </block>
        <block type="controls_forEach"></block>
        <block type="controls_flow_statements"></block>
    </category>
    <category id="catMath" colour="230" name="Math">
        <block type="math_number"></block>
        <block type="math_arithmetic">
            <value name="A">
                <shadow type="math_number">
                    <field name="NUM">1</field>
                </shadow>
            </value>
            <value name="B">
                <shadow type="math_number">
                    <field name="NUM">1</field>
                </shadow>
            </value>
        </block>
        <block type="math_single">
            <value name="NUM">
                <shadow type="math_number">
                    <field name="NUM">9</field>
                </shadow>
            </value>
        </block>
        <block type="math_trig">
            <value name="NUM">
                <shadow type="math_number">
                    <field name="NUM">45</field>
                </shadow>
            </value>
        </block>
        <block type="math_constant"></block>
        <block type="math_number_property">
            <value name="NUMBER_TO_CHECK">
                <shadow type="math_number">
                    <field name="NUM">0</field>
                </shadow>
            </value>
        </block>
        <block type="math_change">
            <value name="DELTA">
                <shadow type="math_number">
                    <field name="NUM">1</field>
                </shadow>
            </value>
        </block>
        <block type="math_round">
            <value name="NUM">
                <shadow type="math_number">
                    <field name="NUM">3.1</field>
                </shadow>
            </value>
        </block>
        <block type="math_on_list"></block>
        <block type="math_modulo">
            <value name="DIVIDEND">
                <shadow type="math_number">
                    <field name="NUM">64</field>
                </shadow>
            </value>
            <value name="DIVISOR">
                <shadow type="math_number">
                    <field name="NUM">10</field>
                </shadow>
            </value>
        </block>
        <block type="math_constrain">
            <value name="VALUE">
                <shadow type="math_number">
                    <field name="NUM">50</field>
                </shadow>
            </value>
            <value name="LOW">
                <shadow type="math_number">
                    <field name="NUM">1</field>
                </shadow>
            </value>
            <value name="HIGH">
                <shadow type="math_number">
                    <field name="NUM">100</field>
                </shadow>
            </value>
        </block>
        <block type="math_random_int">
            <value name="FROM">
                <shadow type="math_number">
                    <field name="NUM">1</field>
                </shadow>
            </value>
            <value name="TO">
                <shadow type="math_number">
                    <field name="NUM">100</field>
                </shadow>
            </value>
        </block>
        <block type="math_random_float"></block>
    </category>
    <category id="catText" colour="160" name="Text">
        <block type="text"></block>
        <block type="text_join"></block>
        <block type="text_append">
            <value name="TEXT">
                <shadow type="text"></shadow>
            </value>
        </block>
        <block type="text_length">
            <value name="VALUE">
                <shadow type="text">
                    <field name="TEXT">abc</field>
                </shadow>
            </value>
        </block>
        <block type="text_isEmpty">
            <value name="VALUE">
                <shadow type="text">
                    <field name="TEXT"></field>
                </shadow>
            </value>
        </block>
        <block type="text_indexOf">
            <value name="VALUE">
                <block type="variables_get">
                    <field name="VAR">text</field>
                </block>
            </value>
            <value name="FIND">
                <shadow type="text">
                    <field name="TEXT">abc</field>
                </shadow>
            </value>
        </block>
        <block type="text_charAt">
            <value name="VALUE">
                <block type="variables_get">
                    <field name="VAR">text</field>
                </block>
            </value>
        </block>
        <block type="text_getSubstring">
            <value name="STRING">
                <block type="variables_get">
                    <field name="VAR">text</field>
                </block>
            </value>
        </block>
        <block type="text_changeCase">
            <value name="TEXT">
                <shadow type="text">
                    <field name="TEXT">abc</field>
                </shadow>
            </value>
        </block>
        <block type="text_trim">
            <value name="TEXT">
                <shadow type="text">
                    <field name="TEXT">abc</field>
                </shadow>
            </value>
        </block>
        <block type="text_print">
            <value name="TEXT">
                <shadow type="text">
                    <field name="TEXT">abc</field>
                </shadow>
            </value>
        </block>
        <block type="text_prompt_ext">
            <value name="TEXT">
                <shadow type="text">
                    <field name="TEXT">abc</field>
                </shadow>
            </value>
        </block>
    </category>
    <category id="catLists" colour="260" name="Lists">
        <block type="lists_create_with">
            <mutation items="0"></mutation>
        </block>
        <block type="lists_create_with"></block>
        <block type="lists_repeat">
            <value name="NUM">
                <shadow type="math_number">
                    <field name="NUM">5</field>
                </shadow>
            </value>
        </block>
        <block type="lists_length"></block>
        <block type="lists_isEmpty"></block>
        <block type="lists_indexOf">
            <value name="VALUE">
                <block type="variables_get">
                    <field name="VAR">list</field>
                </block>
            </value>
        </block>
        <block type="lists_getIndex">
            <value name="VALUE">
                <block type="variables_get">
                    <field name="VAR">list</field>
                </block>
            </value>
        </block>
        <block type="lists_setIndex">
            <value name="LIST">
                <block type="variables_get">
                    <field name="VAR">list</field>
                </block>
            </value>
        </block>
        <block type="lists_getSublist">
            <value name="LIST">
                <block type="variables_get">
                    <field name="VAR">list</field>
                </block>
            </value>
        </block>
        <block type="lists_split">
            <value name="DELIM">
                <shadow type="text">
                    <field name="TEXT">,</field>
                </shadow>
            </value>
        </block>
        <block type="lists_sort"></block>
    </category>

    <category id="catVariables" colour="330" custom="VARIABLE" name="Variables"></category>
    <category id="catFunctions" colour="290" custom="PROCEDURE" name="Functions"></category>
    <sep></sep>
    <category id="catRobotMove" colour="250" custom="ROBOT_MOVE" name="Move"></category>
    <category id="catRobotSides" colour="240" custom="ROBOT_SIDES" name="Sides"></category>
    <category id="catRobotInventory" colour="240" custom="ROBOT_INVENTORY" name="Inventory"></category>
    <category id="catRobotStack" colour="240" custom="ROBOT_STACK" name="ItemStack"></category>
    <category id="catGeolyzer" colour="240" custom="GEOLYZER" name="Geolyzer"></category>
    <category id="catSystem" colour="240" custom="SYSTEM" name="System"></category>
    <category id="catTime" colour="240" custom="TIME" name="Time"></category>
    <category id="catRedstone" colour="240" custom="REDSTONE" name="Redstone"></category>
    <category id="catZetta" colour="240" custom="ZETTA" name="Zetta Industries"></category>

</xml>
<div class="body">
    <div class="toolbar">
        <span>OC-Blockly |</span>
        <button onclick="save()">Save</button>
        <button onclick="loadFromCode()">Load</button>
        <div class="right">
            <span>created by <a href="https://bymarcin.com">marcin212</a></span>
            <span> | version: alpha-0.6 | <a href="https://github.com/marcin212/OC-Blockly/issues">ISSUES</a> </span>
        </div>
    </div>
    <div class="content">
        <div class="vertically_divided">
            <div id="blocklyArea">
                <div id="blocklyDiv"></div>
            </div>
            <div id="editorArea">
                <div id="editorDiv"></div>
            </div>
        </div>
    </div>
</div>
<script src="js/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editorDiv");
    editor.setTheme("ace/theme/ambiance");
    editor.getSession().setMode("ace/mode/lua");
    editor.$blockScrolling = Infinity;
    //var workspace = Blockly.inject('blocklyDiv', {toolbox: document.getElementById('toolbox')});

    //

    var blocklyArea = document.getElementById('blocklyArea');
    var blocklyDiv = document.getElementById('blocklyDiv');
    var workspace = Blockly.inject(blocklyDiv, {toolbox: document.getElementById('toolbox')});
    var onresize = function (e) {
        // Compute the absolute coordinates and dimensions of blocklyArea.
        var element = blocklyArea;
        var x = 0;
        var y = 0;
        // do {
        x += element.offsetLeft;
        y += element.offsetTop;
        element = element.offsetParent;
        //} while (element);
        // Position blocklyDiv over blocklyArea.
        blocklyDiv.style.left = x + 'px';
        blocklyDiv.style.top = y + 'px';
        blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
        blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
        Blockly.svgResize(workspace);
    };
    splitMe.updateListeners.push(onresize);

    onresize();
    ///


    var header = 'local robot = require("robot")\n' +
        'local computer = require("computer")\n' +
        'local sides = require("sides")\n' +
        'local component = require("component")\n' +
        'local event = require("event")\n' +
        '\n';

    function showLoading(bool) {
        if (!bool) {
            document.getElementsByClassName("loader")[0].classList.add("hidden");
            document.getElementsByClassName("loader-gif")[0].classList.add("hidden");
        } else {
            document.getElementsByClassName("loader")[0].classList.remove("hidden");
            document.getElementsByClassName("loader-gif")[0].classList.remove("hidden");
        }
    }

    function save() {
        showLoading(true);
        try {
            const xml = Blockly.Xml.workspaceToDom(workspace);
            const xml_text = Blockly.Xml.domToText(xml);
            const compressed = LZString.compressToBase64(xml_text);
            const id = gist.add(compressed);
            alert("saved as:" + id);
            window.location.hash = '#' + id;
        }
        catch (err) {
            alert("Error during saving data.");
            console.error(err);
        }
        showLoading(false);
    }

    function load() {
        showLoading(true);
        try {
            var compressed = gist.get(window.location.hash.substring(1));
            var decompressed = LZString.decompressFromBase64(compressed);
            var xml = Blockly.Xml.textToDom(decompressed);
            Blockly.Xml.domToWorkspace(xml, workspace);
        }
        catch (err) {
            alert("Error during loading data.")
        }
        showLoading(false);
    }

    function loadFromCode() {
        var code = prompt("Code: ", "");
        window.location.hash = '#' + code;
        load();
    }

    function myUpdateFunction(event) {
        var code = header + Blockly.Lua.workspaceToCode(workspace);
        editor.setValue(code);
    }
    workspace.addChangeListener(myUpdateFunction);
    workspace.registerToolboxCategoryCallback('ROBOT_MOVE', robot_move.toolboxCategory);
    workspace.registerToolboxCategoryCallback('ROBOT_SIDES', robot_sides.toolboxCategory);
    workspace.registerToolboxCategoryCallback('ROBOT_INVENTORY', robot_inventory.toolboxCategory);
    workspace.registerToolboxCategoryCallback('ROBOT_STACK', robot_stack.toolboxCategory);
    workspace.registerToolboxCategoryCallback('GEOLYZER', geolyzer.toolboxCategory);
    workspace.registerToolboxCategoryCallback('SYSTEM', system.toolboxCategory);
    workspace.registerToolboxCategoryCallback('TIME', time.toolboxCategory);
    workspace.registerToolboxCategoryCallback('REDSTONE', redstone.toolboxCategory);
    workspace.registerToolboxCategoryCallback('ZETTA', zetta.toolboxCategory);
    document.addEventListener("DOMContentLoaded", function (event) {
        if (window.location.hash != "" && window.location.hash != "#") {
            load();
        }
    });

    Blockly.BlockSvg.START_HAT = true;
</script>

</body>
</html>